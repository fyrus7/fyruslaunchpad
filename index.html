<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Launchpad - Note Grid</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(4, 80px); gap: 8px; justify-content: center; margin-top: 20px; }
    button { padding: 20px; font-size: 14px; border: none; border-radius: 8px; background: #333; color: #fff; cursor: pointer; }
    button:active { background: #555; }
    .layer { margin: 10px auto; padding: 10px; border: 1px solid #444; border-radius: 8px; width: 350px; }
    .controls { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Web Launchpad (Note Grid)</h1>
  <button onclick="toggleMode()">Switch Note/Chord</button>
  <div class="grid" id="padGrid"></div>

  <h2>Layers</h2>
  <div id="layers"></div>
  <button onclick="addLayer()">+ Add Layer</button>

<script>
const synth = new Tone.PolySynth(Tone.Synth).toDestination();
let isNoteMode = true;
let startNoteIndex = 48; // C3 (MIDI 48)

// Scale notes untuk grid
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function midiToNote(midi) {
  const octave = Math.floor(midi/12) - 1;
  const name = noteNames[midi % 12];
  return name + octave;
}

// Chord bank (optional)
const chordBank = ["C","Dm","Em","F","G","Am","Bdim","C7"];

function buildPads() {
  const grid = document.getElementById("padGrid");
  grid.innerHTML = "";
  if (isNoteMode) {
    // generate 16 note pad
    for (let i=0; i<16; i++) {
      const note = midiToNote(startNoteIndex + i);
      const btn = document.createElement("button");
      btn.innerText = note;
      btn.onclick = () => playNote(note);
      grid.appendChild(btn);
    }
  } else {
    chordBank.forEach(ch => {
      const btn = document.createElement("button");
      btn.innerText = ch;
      btn.onclick = () => playChord(ch);
      grid.appendChild(btn);
    });
  }
}
buildPads();

function toggleMode() {
  isNoteMode = !isNoteMode;
  buildPads();
}

function playNote(note) {
  const now = Tone.now();
  synth.triggerAttackRelease(note, "8n", now);
  // record kalau ada layer
  layers.forEach(layer => {
    if (layer.isRecording) {
      layer.events.push({time: now - layer.startTime, type:"note", value: note});
    }
  });
}

function playChord(chord) {
  const map = {
    "C":["C4","E4","G4"], "Dm":["D4","F4","A4"], "Em":["E4","G4","B4"],
    "F":["F4","A4","C5"], "G":["G4","B4","D5"], "Am":["A4","C5","E5"], "Bdim":["B4","D5","F5"],
    "C7":["C4","E4","G4","A#4"]
  };
  const now = Tone.now();
  const notes = map[chord] || ["C4"];
  synth.triggerAttackRelease(notes, "1n", now);
  // record kalau ada layer
  layers.forEach(layer => {
    if (layer.isRecording) {
      layer.events.push({time: now - layer.startTime, type:"chord", value: chord});
    }
  });
}

// ================= Layers ==================
let layers = [];

function addLayer() {
  const idx = layers.length;
  const layer = { events: [], isRecording: false, isPlaying: false, loopId: null, startTime: 0 };
  layers.push(layer);

  const div = document.createElement("div");
  div.className = "layer";
  div.innerHTML = `<b>Layer ${idx+1}</b>
    <div class="controls">
      <button onclick="recordLayer(${idx})">Record</button>
      <button onclick="stopRecord(${idx})">Stop</button>
      <button onclick="playLayer(${idx})">Play</button>
      <button onclick="stopLayer(${idx})">Stop Play</button>
      <button onclick="clearLayer(${idx})">Clear</button>
      <button onclick="deleteLayer(${idx})">Delete</button>
    </div>`;
  document.getElementById("layers").appendChild(div);
}

function recordLayer(i) {
  layers[i].events = [];
  layers[i].isRecording = true;
  layers[i].startTime = Tone.now();
  alert("Recording Layer " + (i+1));
}
function stopRecord(i) {
  layers[i].isRecording = false;
}
function playLayer(i) {
  if (layers[i].events.length === 0) { alert("No events in Layer " + (i+1)); return; }
  layers[i].isPlaying = true;
  const duration = layers[i].events[layers[i].events.length-1].time + 2; // loop length
  function schedule() {
    layers[i].events.forEach(e => {
      if (e.type === "note") synth.triggerAttackRelease(e.value, "8n", Tone.now() + e.time);
      if (e.type === "chord") playChord(e.value);
    });
  }
  schedule();
  layers[i].loopId = setInterval(schedule, duration*1000);
}
function stopLayer(i) {
  layers[i].isPlaying = false;
  if (layers[i].loopId) clearInterval(layers[i].loopId);
}
function clearLayer(i) {
  stopLayer(i);
  layers[i].events = [];
  alert("Layer " + (i+1) + " cleared");
}
function deleteLayer(i) {
  stopLayer(i);
  layers[i] = null; // buang dari array
  document.getElementById("layers").children[i].remove(); // buang UI
}
</script>
</body>
</html>
