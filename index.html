<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Web Launchpad - Note Grid</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; text-align: center; }
    .grid { display: grid; grid-template-columns: repeat(4, 80px); gap: 8px; justify-content: center; margin-top: 20px; }
    button { padding: 20px; font-size: 14px; border: none; border-radius: 8px; background: #333; color: #fff; cursor: pointer; }
    button:active { background: #555; }
    .layer { margin: 10px auto; padding: 10px; border: 1px solid #444; border-radius: 8px; width: 350px; }
    .controls { margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Web Launchpad (Note Grid)</h1>
  <button onclick="toggleMode()">Switch Note/Chord</button>
  <div class="grid" id="padGrid"></div>

  <h2>Layers</h2>
  <div id="layers"></div>
  <button onclick="addLayer()">+ Add Layer</button>

<script>
const synth = new Tone.PolySynth(Tone.Synth).toDestination();
let isNoteMode = true;
let startNoteIndex = 48; // C3 (MIDI 48)

// Scale notes untuk grid
const noteNames = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function midiToNote(midi) {
  const octave = Math.floor(midi/12) - 1;
  const name = noteNames[midi % 12];
  return name + octave;
}

// Chord bank
const chordBank = ["C","Dm","Em","F","G","Am","Bdim","C7"];
function getChordNotes(chord) {
  const map = {
    "C":["C4","E4","G4"], "Dm":["D4","F4","A4"], "Em":["E4","G4","B4"],
    "F":["F4","A4","C5"], "G":["G4","B4","D5"], "Am":["A4","C5","E5"], "Bdim":["B4","D5","F5"],
    "C7":["C4","E4","G4","A#4"]
  };
  return map[chord] || ["C4"];
}

function buildPads() {
  const grid = document.getElementById("padGrid");
  grid.innerHTML = "";
  if (isNoteMode) {
    for (let i=0; i<16; i++) {
      const note = midiToNote(startNoteIndex + i);
      const btn = document.createElement("button");
      btn.innerText = note;
      btn.onclick = () => playNote(note);
      grid.appendChild(btn);
    }
  } else {
    chordBank.forEach(ch => {
      const btn = document.createElement("button");
      btn.innerText = ch;
      btn.onclick = () => playChord(ch);
      grid.appendChild(btn);
    });
  }
}
buildPads();

function toggleMode() {
  isNoteMode = !isNoteMode;
  buildPads();
}

function playNote(note) {
  const now = Tone.now();
  synth.triggerAttackRelease(note, "8n", now);
  layers.forEach(layer => {
    if (layer.isRecording) {
      layer.events.push({time: now - layer.startTime, type:"note", value: note});
    }
  });
}

function playChord(chord) {
  const now = Tone.now();
  const notes = getChordNotes(chord);
  synth.triggerAttackRelease(notes, "1n", now);
  layers.forEach(layer => {
    if (layer.isRecording) {
      layer.events.push({time: now - layer.startTime, type:"chord", value: chord});
    }
  });
}

// ================= Layers ==================
let layers = [];
let layerCounter = 0; // unique ID counter

function addLayer() {
  const idx = layers.length;
  const layerId = "layer-" + (++layerCounter);
  const layer = { id: layerId, events: [], isRecording: false, isPlaying: false, loopId: null, startTime: 0 };
  layers.push(layer);

  const div = document.createElement("div");
  div.className = "layer";
  div.id = layerId;
  div.innerHTML = `<b>Layer ${idx+1}</b>
    <div class="controls">
      <button onclick="recordLayer('${layerId}')">Record</button>
      <button onclick="stopRecord('${layerId}')">Stop</button>
      <button onclick="playLayer('${layerId}')">Play</button>
      <button onclick="stopLayer('${layerId}')">Stop Play</button>
      <button onclick="clearLayer('${layerId}')">Clear</button>
      <button onclick="deleteLayer('${layerId}')">Delete</button>
    </div>`;
  document.getElementById("layers").appendChild(div);
}

function getLayerById(id) {
  return layers.find(l => l && l.id === id);
}

function recordLayer(id) {
  const layer = getLayerById(id);
  if (!layer) return;
  layer.events = [];
  layer.isRecording = true;
  layer.startTime = Tone.now();
  alert("Recording " + id);
}
function stopRecord(id) {
  const layer = getLayerById(id);
  if (layer) layer.isRecording = false;
}

function playLayer(id) {
  const layer = getLayerById(id);
  if (!layer || layer.events.length === 0) return alert("No events in " + id);
  layer.isPlaying = true;
  const duration = layer.events[layer.events.length-1].time + 2; // loop length

  function schedule() {
    layer.events.forEach(e => {
      if (e.type === "note") {
        synth.triggerAttackRelease(e.value, "8n", Tone.now() + e.time);
      }
      if (e.type === "chord") {
        const notes = getChordNotes(e.value);
        synth.triggerAttackRelease(notes, "1n", Tone.now() + e.time);
      }
    });
  }
  schedule();
  layer.loopId = setInterval(schedule, duration*1000);
}

function stopLayer(id) {
  const layer = getLayerById(id);
  if (layer && layer.loopId) {
    clearInterval(layer.loopId);
    layer.isPlaying = false;
  }
}

function clearLayer(id) {
  const layer = getLayerById(id);
  if (layer) {
    stopLayer(id);
    layer.events = [];
    alert(id + " cleared");
  }
}

function deleteLayer(id) {
  const layer = getLayerById(id);
  if (!layer) return;
  stopLayer(id);
  // buang dari array
  layers = layers.filter(l => l && l.id !== id);
  // buang UI
  const div = document.getElementById(id);
  if (div) div.remove();
}
</script>

</body>
</html>
