<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Launchpad</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,sans-serif; background:#0d1014; color:#eaf0fb; }
    header { padding:12px; border-bottom:1px solid #1f2736; display:flex; flex-direction:column; gap:8px; align-items:center; position:sticky; top:0; background:#0d1014cc; z-index:20; }
    .top-row { width:100%; max-width:980px; display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .controls { display:flex; gap:42px; align-items:center; }
    .modeBtn, .btn, .pageBtn, .small-input { padding:8px 10px; border-radius:10px; border:1px solid #2a3648; background:#12161b; color:#eaf0fb; cursor:pointer; }
    .modeBtn.primary { background:#1f5eff; border-color:#2a66ff; }
    .small { font-size:0.92rem; color:#c7d1e6; }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid #2a3445; background:#0f1419; }
    .page-row { width:100%; max-width:980px; margin-top:6px; display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; }

    main { padding:12px; display:flex; flex-direction:column; align-items:center; gap:14px; }

    #padGrid { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; width:min(760px, 96vw); }
    .pad {
      display:flex; align-items:center; justify-content:center; border-radius:10px;
      font-weight:700; background:#151922; border:1px solid #263044; color:#eaf0fb;
      user-select:none; touch-action:manipulation; padding:6px;
      aspect-ratio: 1 / 1;
      min-width:46px; min-height:46px;
      transition: transform 0.05s, filter 0.05s;
    }
    .pad .label { white-space:normal; text-align:center; line-height:1.02; font-size:13px; word-break:break-word; }
    .pad:active { transform: translateY(1px); filter:brightness(1.12); }

    /* --- FLASH PATCH --- */
    .pad.flash {
      background: linear-gradient(180deg,#1a73ff,#4dabff); /* biru glow */
      box-shadow: 0 0 12px rgba(26,115,255,.8);
      transition: background 0.08s, box-shadow 0.08s;
    }

    .pad.note { background:linear-gradient(180deg,#12161b,#0f1418); }
    .pad.chord { background:linear-gradient(180deg,#162026,#11161b); }
    .pad.drum { background:linear-gradient(180deg,#251419,#1b0f12); }

    #layersWrap { width:min(980px,96vw); display:flex; flex-direction:column; gap:8px; }
    .layer { border-radius:10px; padding:10px; background:#0f1419; border:1px solid #222a38; display:flex; flex-direction:column; gap:8px; }
    .layer .top { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .layer .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .layer button { padding:8px 10px; border-radius:8px; border:1px solid #263044; background:#12161b; color:#eaf0fb; cursor:pointer; }
    .layer button.recording { background:#b52020 !important; color:#fff; animation: blink 1s infinite; border-color:#8f1a1a; }
    .layer button.activeRec { background:#1fa02b !important; color:#fff; border-color:#16761b; }
    @keyframes blink { 0%,50%,100%{opacity:1} 25%,75%{opacity:.5} }
    .muted { color:#9aa6c7; font-size:.92rem; }
    .msg { color:#f2c94c; font-weight:600; margin-left:6px; }
    footer { height:60px; }

    @media (max-width:420px){
      .pad .label { font-size:12px; }
      .pad { min-height:54px; }
    }
  </style>
</head>
<body>

<header>
  <div class="top-row">
    <div class="controls">
      <button id="modeBtn" class="modeBtn">Mode: Note</button>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="small muted">Octave</span>
        <button id="octDown" class="btn">−</button>
        <span id="octLabel" class="pill">C3</span>
        <button id="octUp" class="btn">+</button>
      </div>
    </div>
  </div>

  <div class="page-row">
    <div class="pager">
      <button id="prevPage" class="pageBtn">⬅ Prev</button>
      <span id="pageIndicator" class="pill">Page 1</span>
      <button id="nextPage" class="pageBtn">Next ➡</button>
    </div>
    <div style="width:12px"></div>
    <button id="addLayerBtn" class="modeBtn primary">+ Add Layer</button>
  </div>
</header>

<main>
  <div id="padGrid" role="grid" aria-label="Launchpad grid"></div>

  <section style="width:min(980px,96vw);">
    <h3 style="margin:6px 0 8px 0">Layers</h3>
    <div id="layersWrap"></div>
  </section>
</main>

<footer></footer>

<script>
const synth = new Tone.PolySynth(Tone.Synth, {
  maxPolyphony: 32,
  options: { envelope: { attack: 0.005, decay: 0.18, sustain: 0.38, release: 0.5 } }
}).toDestination();

const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const midiToNote = (m) => `${NOTE_NAMES[m % 12]}${Math.floor(m/12)-1}`;
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

let mode = 'note';
let baseMidi = 48;
const cols = 5, rows = 6;
const padsPerPage = cols * rows;
let currentPage = 0;

const chordModeList = ["C","Dm","Em","F","G","Am","Bdim","C7"];
const chordMap = {
  "C":["C4","E4","G4"], "Dm":["D4","F4","A4"], "Em":["E4","G4","B4"],
  "F":["F4","A4","C5"], "G":["G4","B4","D5"], "Am":["A4","C5","E5"],
  "Bdim":["B4","D5","F5"], "C7":["C4","E4","G4","A#4"]
};

const drumBase = 'https://oramics.github.io/sampled/DM/TR-909/Detroit/samples/';
const drumFiles = [
  'kick.wav','snare.wav','hihat-closed.wav','hihat-open-1.wav',
  'clap-1.wav','rim.wav','tom-l.wav','tom-h.wav',
  'ride.wav','cymbal.wav','kick-short.wav','hihat-open-2.wav',
  'clap-2.wav','tom-h.wav','snare.wav','rim.wav'
];
const drumPlayers = {};
async function loadDrumPlayers(){
  for (const f of drumFiles){
    const url = drumBase + f;
    try { drumPlayers[f] = new Tone.Player({ url, autostart:false }).toDestination(); } 
    catch(e){ console.warn('Failed to create player', f, e); }
  }
  console.log('drum players ready');
}
loadDrumPlayers();

const padGrid = document.getElementById('padGrid');
const pageIndicator = document.getElementById('pageIndicator');
const modeBtn = document.getElementById('modeBtn');
const octLabel = document.getElementById('octLabel');
const octDown = document.getElementById('octDown');
const octUp = document.getElementById('octUp');
const prevPageBtn = document.getElementById('prevPage');
const nextPageBtn = document.getElementById('nextPage');
const addLayerBtn = document.getElementById('addLayerBtn');

function updateOctLabel(){ octLabel.textContent = midiToNote(baseMidi); }
updateOctLabel();
octDown.addEventListener('click', ()=> { baseMidi = clamp(baseMidi-12, 24, 84); updateOctLabel(); renderGrid(); });
octUp.addEventListener('click', ()=> { baseMidi = clamp(baseMidi+12, 24, 84); updateOctLabel(); renderGrid(); });

modeBtn.addEventListener('click', () => {
  mode = (mode === 'note') ? 'chord' : (mode === 'chord' ? 'drum' : 'note');
  modeBtn.textContent = `Mode: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`;
  currentPage = 0;
  renderGrid();
});
prevPageBtn.addEventListener('click', ()=>{ if(currentPage>0) currentPage--; renderGrid(); });
nextPageBtn.addEventListener('click', ()=>{ if(currentPage<totalPagesForMode()-1) currentPage++; renderGrid(); });

function totalPagesForMode(){
  if (mode === 'note') return Math.ceil(72/padsPerPage);
  if (mode === 'chord') return Math.ceil(chordModeList.length/padsPerPage);
  return Math.ceil(drumFiles.length/padsPerPage);
}

/* --- FLASH PATCH --- */
function flashPad(el){
  if(!el) return;
  el.classList.add('flash');
  const origBg = el.style.background;
  el.style.background = '#ffffff';
  setTimeout(()=>{ el.classList.remove('flash'); el.style.background = origBg; }, 100);
}

/* Play immediate */
function playNoteImmediate(note){
  synth.triggerAttackRelease(note,'8n',Tone.now());
  layers.forEach(L => {
    if(L.isRecording){ let t=performance.now()-L.recStartTime; t=Math.max(0,t);
      L.events.push({time:t,type:'note',value:note,dur:0.25}); L.msg=''; }
  });
}
function playChordImmediate(name){
  const notes = chordMap[name]; if(!notes) return;
  try { synth.releaseAll(); } catch(e){}
  synth.triggerAttackRelease(notes,'1n',Tone.now());
  layers.forEach(L => { if(L.isRecording){ let t=performance.now()-L.recStartTime; t=Math.max(0,t); L.events.push({time:t,type:'chord',value:name,dur:1.0}); L.msg=''; } });
}
function playDrumImmediate(fname){
  const p = drumPlayers[fname];
  layers.forEach(L => { if(L.isRecording){ let t=performance.now()-L.recStartTime; t=Math.max(0,t); L.events.push({time:t,type:'drum',value:fname}); L.msg=''; } });
  if(p){ try{ p.start(); }catch(e){console.warn(e);} }
}

function renderGrid(){
  padGrid.innerHTML = '';
  const pages = totalPagesForMode();
  if(currentPage<0) currentPage=0;
  if(currentPage>=pages) currentPage=pages-1;
  pageIndicator.textContent = `Page ${currentPage+1}`;

  if(mode==='note'){
    const totalNotes=72;
    const startIndex=currentPage*padsPerPage;
    const globalStart=baseMidi-12;
    for(let i=0;i<padsPerPage;i++){
      const globalIdx=startIndex+i;
      const midi=globalStart+globalIdx;
      const note=midiToNote(midi);
      const btn=document.createElement('button');
      btn.className='pad note';
      btn.innerHTML=`<div class="label">${note}</div>`;
      btn.onclick=async()=>{ await Tone.start(); flashPad(btn); playNoteImmediate(note); };
      padGrid.appendChild(btn);
    }
  } else if(mode==='chord'){
    const start=currentPage*padsPerPage;
    for(let i=0;i<padsPerPage;i++){
      const idx=start+i;
      if(idx<chordModeList.length){
        const chordName=chordModeList[idx];
        const btn=document.createElement('button');
        btn.className='pad chord';
        btn.innerHTML=`<div class="label">${chordName}</div>`;
        btn.onclick=async()=>{ await Tone.start(); flashPad(btn); playChordImmediate(chordName); };
        padGrid.appendChild(btn);
      } else { const placeholder=document.createElement('div'); placeholder.style.visibility='hidden'; padGrid.appendChild(placeholder); }
    }
  } else {
    const start=currentPage*padsPerPage;
    for(let i=0;i<padsPerPage;i++){
      const idx=(start+i)%drumFiles.length;
      const fname=drumFiles[idx];
      const label=fname.replace(/\.[^/.]+$/,'').replace(/[_-]/g,' ');
      const btn=document.createElement('button');
      btn.className='pad drum';
      btn.innerHTML=`<div class="label">${label}</div>`;
      btn.onclick=async()=>{ await Tone.start(); flashPad(btn); playDrumImmediate(fname); };
      padGrid.appendChild(btn);
    }
  }
}
renderGrid();

/* --- Layers --- */
let layers=[]; let idCounter=0;
const layersWrap=document.getElementById('layersWrap');
addLayerBtn.addEventListener('click',addLayer);
function addLayer(){
  const id=`L${++idCounter}`;
  const layer={id,name:`Layer ${layers.length+1}`,events:[],isRecording:false,isPlaying:false,recStartTime:0,loopLengthMs:0,part:null,msg:''};
  layers.push(layer); renderLayers();
}
function renderLayers(){
  layersWrap.innerHTML='';
  layers.forEach(L=>{
    const el=document.createElement('div');
    el.className='layer'; el.id=L.id;
    el.innerHTML=`
      <div class="top">
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="font-weight:700">${L.name}</div>
          <div class="muted">${L.events.length} event${L.events.length!==1?'s':''}</div>
          ${L.msg?`<div class="msg" id="${L.id}-msg">${L.msg}</div>`:''}
        </div>
        <div class="muted small">Loop: <span id="${L.id}-loop">—</span></div>
      </div>
      <div class="controls">
        <button data-act="record" data-id="${L.id}">Rec</button>
        <button data-act="play" data-id="${L.id}">Play</button>
        <button data-act="stop" data-id="${L.id}">Stop</button>
      </div>
    `;
    layersWrap.appendChild(el);
  });

  layersWrap.querySelectorAll('button').forEach(btn=>{
    const act=btn.dataset.act; const id=btn.dataset.id;
    const L=layers.find(x=>x.id===id); if(!L) return;
    btn.onclick=()=>{ if(act==='record'){ if(!L.isRecording){ L.isRecording=true; L.recStartTime=performance.now(); btn.classList.add('recording'); L.msg='Recording'; } else { L.isRecording=false; btn.classList.remove('recording'); L.msg='Stopped'; } renderLayers(); }
    else if(act==='play'){ if(!L.isPlaying){ L.isPlaying=true; L.msg='Playing'; playLayer(L); } renderLayers(); }
    else if(act==='stop'){ L.isPlaying=false; if(L.part){ L.part.stop(); L.part=null; } L.msg='Stopped'; renderLayers(); } };
  });
}

function playLayer(L){
  if(!L.events.length) return;
  const now=Tone.now();
  L.events.forEach(ev=>{
    if(ev.type==='note') synth.triggerAttackRelease(ev.value,'8n',now+ev.time/1000);
    else if(ev.type==='chord'){ const notes=chordMap[ev.value]; if(notes) synth.triggerAttackRelease(notes,'1n',now+ev.time/1000); }
    else if(ev.type==='drum'){ const p=drumPlayers[ev.value]; if(p) p.start(now+ev.time/1000); }
  });
  setTimeout(()=>{ L.isPlaying=false; L.msg='Stopped'; renderLayers(); }, L.events[L.events.length-1].time+1000);
}
</script>

</body>
</html>
