<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Step Sequencer</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 0;
    }
    h1 { margin: 10px 0; }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 10px 0 20px;
    }
    .controls select, .controls button {
      padding: 5px 10px;
      font-size: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      grid-template-rows: repeat(6, 60px);
      gap: 5px;
      margin: 10px 0;
    }
    .grid button {
      width: 60px;
      height: 60px;
      background: #333;
      color: #fff;
      border: 1px solid #666;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      white-space: pre-line; /* break text into 2 lines */
      text-align: center;
    }
    .grid button.active {
      background: #0f0;
      color: #000;
    }
    .layers {
      margin-top: 15px;
      border: 1px solid #444;
      padding: 10px;
      width: 340px;
      min-height: 60px;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>Step Sequencer</h1>

  <div class="controls">
    <div>
      <label>Mode:</label>
      <select id="mode">
        <option value="note">Note</option>
        <option value="chord">Chord</option>
        <option value="drum">Drum</option>
      </select>
    </div>
    <div style="margin-left:20px;">
      <label>Octave:</label>
      <select id="octave">
        <option value="3">3</option>
        <option value="4" selected>4</option>
        <option value="5">5</option>
      </select>
    </div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="controls">
    <button id="prevPage">Prev</button>
    <button id="nextPage">Next</button>
    <button id="addLayer">Add Layer</button>
    <button id="play">Play</button>
    <button id="record">Record</button>
  </div>

  <div class="layers" id="layers"></div>

  <script>
    const grid = document.getElementById("grid");
    const modeSel = document.getElementById("mode");
    const octaveSel = document.getElementById("octave");
    const layersDiv = document.getElementById("layers");

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const chords = ["C","Dm","Em","F","G","Am","Bdim","C7"];
    const drums = [
      "kick","snare","clap","tom",
      "hihat\nclosed","hihat\nopen","ride","crash"
    ];

    let currentMode = "note";
    let currentOctave = 4;

    function clearGrid() { grid.innerHTML = ""; }

    function createGrid() {
      clearGrid();
      let items;
      if (currentMode==="note") {
        items = notes.map(n => n+currentOctave);
      } else if (currentMode==="chord") {
        items = chords;
      } else {
        items = drums;
      }
      for (let i=0;i<30;i++) {
        const btn = document.createElement("button");
        btn.textContent = items[i%items.length];
        btn.onclick = ()=>playItem(btn.textContent);
        grid.appendChild(btn);
      }
    }

    function playItem(name) {
      if (currentMode==="note") playNote(name);
      else if (currentMode==="chord") playChord(name);
      else playDrum(name);
    }

    function playNote(note) {
      const freq = noteToFreq(note);
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type="sine";
      osc.frequency.value=freq;
      osc.connect(gain).connect(audioCtx.destination);
      gain.gain.setValueAtTime(0.2,audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+1);
      osc.start();
      osc.stop(audioCtx.currentTime+1);
    }

    function noteToFreq(note) {
      let n = note.slice(0,-1);
      let o = parseInt(note.slice(-1));
      let idx = notes.indexOf(n);
      let midi = (o+1)*12 + idx;
      return 440 * Math.pow(2,(midi-69)/12);
    }

    function playChord(ch) {
      let chordMap = {
        "C":["C4","E4","G4"],
        "Dm":["D4","F4","A4"],
        "Em":["E4","G4","B4"],
        "F":["F4","A4","C5"],
        "G":["G4","B4","D5"],
        "Am":["A4","C5","E5"],
        "Bdim":["B4","D5","F5"],
        "C7":["C4","E4","G4","Bb4"]
      };
      if (!chordMap[ch]) return;
      chordMap[ch].forEach(n=>playNote(n));
    }

    function playDrum(drum) {
      if (drum.includes("kick")) {
        const osc=audioCtx.createOscillator();
        const gain=audioCtx.createGain();
        osc.frequency.setValueAtTime(150,audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50,audioCtx.currentTime+0.5);
        gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.5);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime+0.5);
      } else if (drum.includes("snare")) {
        const noise = audioCtx.createBufferSource();
        const buffer = audioCtx.createBuffer(1,audioCtx.sampleRate*0.2,audioCtx.sampleRate);
        let data = buffer.getChannelData(0);
        for (let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
        noise.buffer=buffer;
        const filter=audioCtx.createBiquadFilter();
        filter.type="highpass"; filter.frequency.value=1000;
        const gain=audioCtx.createGain();
        gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);
        noise.connect(filter).connect(gain).connect(audioCtx.destination);
        noise.start(); noise.stop(audioCtx.currentTime+0.2);
      } else {
        // fallback
        const osc=audioCtx.createOscillator();
        osc.frequency.value=400;
        const gain=audioCtx.createGain();
        gain.gain.setValueAtTime(0.1,audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.2);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime+0.2);
      }
    }

    modeSel.onchange=()=>{currentMode=modeSel.value;createGrid();};
    octaveSel.onchange=()=>{currentOctave=parseInt(octaveSel.value);createGrid();};

    createGrid();
  </script>
</body>
</html>
